<?xml version = '1.0' encoding = 'UTF-8'?>
<TriggerOraclev10g class="oracle.dbtools.crest.model.design.storage.oracle.v10g.TriggerOraclev10g" name="DOD_JOBS_MONITOR_FAIL" directorySegmentName="seg_0" id="A6084AE5-F9E7-A620-88A0-6CC7ECB94588">
<sourceConnName>DBONDEMAND PROD</sourceConnName>
<sourceObjSchema>DBONDEMAND</sourceObjSchema>
<sourceObjName>DOD_JOBS_MONITOR_FAIL</sourceObjName>
<createdBy>dcollado</createdBy>
<createdTime>2015-11-05 14:08:01 UTC</createdTime>
<ownerDesignName>dbod</ownerDesignName>
<actions>UPDATE</actions>
<body>DECLARE&lt;br/&gt;    message VARCHAR2 (1024);&lt;br/&gt;    max_attachment_size Number:= 32767;&lt;br/&gt;    attachment VARCHAR2(32767);&lt;br/&gt;    attachment_size Number ;&lt;br/&gt;BEGIN&lt;br/&gt;    IF :NEW.state = &apos;FINISHED_FAIL&apos; OR :NEW.state = &apos;FINISHED_WARNING&apos;&lt;br/&gt;    THEN&lt;br/&gt;        message := &apos;&lt;html&gt;&lt;br/&gt;                        &lt;body&gt;&lt;br/&gt;                            The execution of the following job has failed or finished with errors:&lt;br/&gt;                            &lt;ul&gt;&lt;br/&gt;                                &lt;li&gt;&lt;b&gt;Username&lt;/b&gt;: &apos; || :NEW.username || &apos;&lt;/li&gt;&lt;br/&gt;                                &lt;li&gt;&lt;b&gt;DB Name&lt;/b&gt;: &apos; || :NEW.db_name || &apos;&lt;/li&gt;&lt;br/&gt;                                &lt;li&gt;&lt;b&gt;Command name&lt;/b&gt;: &apos; || :NEW.command_name || &apos;&lt;/li&gt;&lt;br/&gt;                                &lt;li&gt;&lt;b&gt;Type&lt;/b&gt;: &apos; || :NEW.type || &apos;&lt;/li&gt;&lt;br/&gt;                                &lt;li&gt;&lt;b&gt;Creation date&lt;/b&gt;: &apos; || TO_CHAR(:NEW.creation_date,&apos;DD/MM/YYYY HH24:MI:SS&apos;) || &apos;&lt;/li&gt;&lt;br/&gt;                                &lt;li&gt;&lt;b&gt;Completion date&lt;/b&gt;: &apos; || TO_CHAR(:NEW.completion_date,&apos;DD/MM/YYYY HH24:MI:SS&apos;) || &apos;&lt;/li&gt;&lt;br/&gt;                                &lt;li&gt;&lt;b&gt;Requester&lt;/b&gt;: &apos; || :NEW.requester || &apos;&lt;/li&gt;&lt;br/&gt;                                &lt;li&gt;&lt;b&gt;Admin action&lt;/b&gt;: &apos; || :NEW.admin_action || &apos;&lt;/li&gt;&lt;br/&gt;                                &lt;li&gt;&lt;b&gt;State&lt;/b&gt;: &apos; || :NEW.state || &apos;&lt;/li&gt;&lt;br/&gt;                            &lt;/ul&gt;&lt;br/&gt;                        &lt;/body&gt;&lt;br/&gt;                    &lt;/html&gt;&apos;;&lt;br/&gt;        attachment_size := LENGTH(:NEW.log); &lt;br/&gt;        IF attachment_size &gt; max_attachment_size&lt;br/&gt;        THEN attachment := &apos;[...] &apos; || DBMS_LOB.SUBSTR(:NEW.log,max_attachment_size-6,attachment_size-max_attachment_size+6+1);&lt;br/&gt;        ELSE attachment := CAST(:NEW.log AS VARCHAR2);&lt;br/&gt;        END IF;&lt;br/&gt;        UTL_MAIL.send_ATTACH_VARCHAR2(sender =&gt; &apos;dbondemand-admin@cern.ch&apos;,&lt;br/&gt;            recipients =&gt; &apos;dbondemand-admin@cern.ch&apos;,&lt;br/&gt;            subject =&gt; &apos;DBOD: CRITICAL: Failed job on &quot;&apos; || :NEW.db_name || &apos;&quot;&apos;,&lt;br/&gt;            message =&gt; message,&lt;br/&gt;            mime_type =&gt; &apos;text/html&apos;,&lt;br/&gt;            attachment =&gt; attachment);&lt;br/&gt;&lt;br/&gt;        :NEW.email_sent := sysdate;&lt;br/&gt;    END IF;&lt;br/&gt;END;&lt;br/&gt;</body>
<triggerTime>BEFORE</triggerTime>
<columns>C1C30987-AED6-56BB-077D-BADE2505D16F</columns>
<owner>CAB88FE4-3E0C-C88B-7B12-C5D629EEEFB4</owner>
<table>50FFE09F-DA98-01E8-51C3-44D37CE14858</table>
</TriggerOraclev10g>